name: Inject Secrets and Deploy to GitHub Pages

on:
  push:
    branches:
      - main # Trigger on push to the main branch

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    # Grant necessary permissions for the GitHub Actions bot
    permissions:
      contents: write # Required for actions/checkout and peaceiris/actions-gh-pages
      pages: write    # Required for deploying to GitHub Pages
      id-token: write # Required for deployment

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --- START: Secret Injection using actions/github-script ---
      # This step uses Node.js (via github-script) for a highly robust and reliable string replacement
      # that completely avoids Bash/sed quoting issues.
      - name: Inject Firebase Secrets into index.html
        id: inject_secrets
        uses: actions/github-script@v7 # Maintained and reliable action for running JS
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const filePath = 'docs/wish/temp.html';
            const newFilePath = 'docs/wish/index.html';
            
            const secrets = {
              API_KEY: process.env.FIREBASE_API_KEY,
              PROJECT_ID: process.env.FIREBASE_PROJECT_ID,
              SENDER_ID: process.env.FIREBASE_MESSAGING_SENDER_ID,
              APP_ID: process.env.FIREBASE_APP_ID,
              MEASUREMENT_ID: process.env.FIREBASE_MEASUREMENT_ID,
              TEST: process.env.TEST_VAR || 'TEST_VAR_NOT_SET' // Default for debug
            };
            
            console.log(`API_KEY (should be masked): ${secrets.API_KEY}`);
            console.log(`TEST (should be visible): ${secrets.TEST}`);

            // 1. Read the file content
            let content = fs.readFileSync(filePath, 'utf8');

            // 2. Perform all substitutions
            content = content.replace(/\$\$API_KEY\$\$/g, secrets.API_KEY);
            content = content.replace(/\$\$PROJECT_ID\$\$/g, secrets.PROJECT_ID);
            content = content.replace(/\$\$SENDER_ID\$\$/g, secrets.SENDER_ID);
            content = content.replace(/\$\$APP_ID\$\$/g, secrets.APP_ID);
            content = content.replace(/\$\$MEASUREMENT_ID\$\$/g, secrets.MEASUREMENT_ID);
            content = content.replace(/\$\$TEST\$\$/g, secrets.TEST); 

            // 3. Write the modified content back to the file
            fs.writeFileSync(newFilePath, content, 'utf8');
            
            console.log('Successfully injected secrets and updated index.html.');
        
        env:
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_MEASUREMENT_ID: ${{ secrets.FIREBASE_MEASUREMENT_ID }}
          TEST_VAR: ${{ secrets.TEST_VAR }}
          
      # --- END: Secret Injection Step ---

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs