name: Inject Secrets and Deploy to GitHub Pages

on:
  push:
    branches:
      - main # Trigger on push to the main branch

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    # Grant necessary permissions for the GitHub Actions bot
    permissions:
      contents: write # Required for actions/checkout and peaceiris/actions-gh-pages
      pages: write    # Required for deploying to GitHub Pages
      id-token: write # Required for deployment

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --- START: Secret Injection using actions/github-script ---
      # This step uses Node.js (via github-script) for a highly robust and reliable string replacement
      # that completely avoids Bash/sed quoting issues.
      - name: Replace vars
        id: inject_secrets
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const filePath = 'docs/wish/temp.html';
            const newFilePath = 'docs/wish/index.html';

            let content = fs.readFileSync(filePath, 'utf8');

            content = content.replace(/\$\$API_KEY\$\$/g, "FIREBASE_API_KEY");
            content = content.replace(/\$\$PROJECT_ID\$\$/g, "FIREBASE_PROJECT_ID");
            content = content.replace(/\$\$SENDER_ID\$\$/g, "FIREBASE_PROJECT_ID");
            content = content.replace(/\$\$APP_ID\$\$/g, "FIREBASE_APP_ID");
            content = content.replace(/\$\$MEASUREMENT_ID\$\$/g, "FIREBASE_MEASUREMENT_ID");
            content = content.replace(/\$\$TEST\$\$/g, "TEST"); 

            // 3. Write the modified content back to the file
            fs.writeFileSync(newFilePath, content, 'utf8');

            console.log(fs.readFileSync(newFilePath, 'utf8'));
            
            console.log('Successfully injected secrets and updated index.html.');
        
        env:
          ENV_FBASE_API_KEY: "${{ secrets.FIREBASE_API_KEY }}"
          ENV_FBASE_PROJECT_ID: "${{ secrets.FIREBASE_PROJECT_ID }}"
          ENV_FBASE_MESSAGING_SENDER_ID: "${{ secrets.FIREBASE_PROJECT_ID }}"
          ENV_FBASE_APP_ID: "${{ secrets.FIREBASE_APP_ID }}"
          ENV_FBASE_MEASUREMENT_ID: "${{ secrets.FIREBASE_MEASUREMENT_ID }}"
          ENV_FVAR: "${{ secrets.ENV_TEST }}"
          
      # --- END: Secret Injection Step ---

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs