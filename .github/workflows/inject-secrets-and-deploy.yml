name: Inject Secrets and Deploy to GitHub Pages

on:
  push:
    branches:
      - main # Trigger on push to the main branch

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    # Grant necessary permissions for the GitHub Actions bot
    permissions:
      contents: write # Required for actions/checkout and peaceiris/actions-gh-pages
      pages: write    # Required for deploying to GitHub Pages
      id-token: write # Required for deployment

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --- START: Secret Injection using actions/github-script ---
      - name: Inject Firebase Secrets into index.html
        id: inject_secrets
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Define the file path relative to the repository root
            const filePath = 'docs/wish/index.html'; // Modify index.html directly
            
            // --- Secret Definitions (Accessed via process.env) ---
            const secrets = {
              API_KEY: process.env.ENV_FBASE_API_KEY,
              PROJECT_ID: process.env.ENV_FBASE_PROJECT_ID,
              SENDER_ID: process.env.ENV_FBASE_MESSAGING_SENDER_ID,
              APP_ID: process.env.ENV_FBASE_APP_ID,
              MEASUREMENT_ID: process.env.ENV_FBASE_MEASUREMENT_ID,
              TEST: process.env.ENV_TEST // Use the correct ENV variable
            };
            
            console.log('--- Starting Secret Injection ---');
            // Log the actual values being used for substitution (will be masked)
            console.log(`API_KEY value check: ${secrets.API_KEY ? 'Set' : 'MISSING'}`);
            console.log(`TEST value check: ${secrets.TEST ? 'Set' : 'MISSING'}`);

            // 1. Read the file content
            let content = fs.readFileSync(filePath, 'utf8');

            // 2. Perform all substitutions using the actual secret values
            content = content.replace(/\$\$API_KEY\$\$/g, secrets.API_KEY);
            content = content.replace(/\$\$PROJECT_ID\$\$/g, secrets.PROJECT_ID);
            content = content.replace(/\$\$SENDER_ID\$\$/g, secrets.SENDER_ID);
            content = content.replace(/\$\$APP_ID\$\$/g, secrets.APP_ID);
            content = content.replace(/\$\$MEASUREMENT_ID\$\$/g, secrets.MEASUREMENT_ID);
            content = content.replace(/\$\$TEST\$\$/g, secrets.TEST); 

            // 3. Write the modified content back to the original file
            fs.writeFileSync(filePath, content, 'utf8');
            
            console.log('Successfully injected secrets and updated index.html.');
            // This is the file that the next step will deploy
        
        env:
          # Expose secrets as environment variables with the ENV_ prefix
          ENV_FBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          ENV_FBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          ENV_FBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          ENV_FBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          ENV_FBASE_MEASUREMENT_ID: ${{ secrets.FIREBASE_MEASUREMENT_ID }}
          ENV_TEST: ${{ secrets.TEST_VAR }}
          
      # --- END: Secret Injection Step ---

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # This deploys the entire contents of the 'docs' folder, which includes docs/wish/index.html
          publish_dir: ./docs